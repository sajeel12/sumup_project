{% extends "main.html" %} {% block content %}
{% load static %}
<section class="main">
    <img id="transaction_loading" src=" {% static 'images/loading.gif' %} " height="25px" style="display: none;" alt="">

    <div class="main-top">
        <!-- <h5> {{username}} </h5> -->
        <!-- <i class="fas fa-user-cog"></i> -->
    </div>
    <div class="main-skills">
        <div class="card">

            <h3>Total Donations</h3>
            <p id="total_transactions">--</p>

        </div>
        <div class="card">
            <!-- <i class="fas fa-laptop-code"></i> -->
            <h3>Donation Last Week</h3>
            <p id="transaction_last_week">--</p>

        </div>
        <div class="card">
            <h3>Donations last 30 days</h3>
            <p id="transaction_last_month">--</p>
        </div>

    </div>
    <div class="main-skills">
        <div class="graph-card">

            <h3>Transactions </h3>
            <select id="productSummarySelect" onchange="handleProductSummuryChange()">

            </select>
            <canvas id="transactionChart" width="100" height="50"></canvas>
        </div>
        <div class="graph-card">

            <h3>Transactions </h3>
            <select id="productSummarySelectBar" onchange="handleProductSummuryBarChange()">
            </select>
            <canvas id="transactionBarChart" width="100" height="50"></canvas>
        </div>

    </div>

</section>


<!-- <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script> -->
<script>


    function get_total_checkouts() {
        fetch("/sumup/checkouts/")  // Replace with the actual URL of your Django view
            .then(data => {
                console.log("Data received:", data);

                // Update the HTML on your page with the received data
                document.getElementById("dataContainer").innerHTML = "Processed Data: " + data.total_checkouts;
            })
            .catch(error => {
                console.error("Fetch error:", error);
            });
    }

    let transaction_loading = document.getElementById('transaction_loading');
    var transactions = [];
    function get_total_transactions() {

        transaction_loading.style.display = 'block';
        fetch("/sumup/transactions/")  // Replace with the actual URL of your Django view
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then(data => {
                console.log("Data received:", data);
                transactions = data.data.items;
                // Update the HTML on your page with the received data
                const objectCount = Object.keys(data?.data?.items).length;

                //  last week  data
                var lastWeekStart = new Date();
                lastWeekStart.setDate(lastWeekStart.getDate() - 7);
                var lastWeekTransactions = data.data.items.filter(function (transaction) {
                    var transactionDate = new Date(transaction.timestamp);
                    return transactionDate > lastWeekStart;
                });
                console.log(lastWeekTransactions, 'lastWeekTransactions')
                const lastWeekCount = Object.keys(lastWeekTransactions).length;

                //  last 30 data
                var lastMonthStart = new Date();
                lastMonthStart.setDate(lastMonthStart.getDate() - 30);
                var lastMonthTransactions = data.data.items.filter(function (transaction) {
                    var transactionDate = new Date(transaction.timestamp);
                    return transactionDate > lastMonthStart;
                });
                console.log(lastMonthTransactions, 'lastMonthTransactions')
                const lastMonthCount = Object.keys(lastMonthTransactions).length;


                //  displaying data
                transaction_loading.style.display = 'none'
                document.getElementById("total_transactions").innerHTML = objectCount;
                document.getElementById("transaction_last_week").innerHTML = lastWeekCount;
                document.getElementById("transaction_last_month").innerHTML = lastMonthCount;

                createLineChart(data?.data?.items);
                createBarChart(data?.data?.items);


                product_summury();

            })
            .catch(error => {
                console.error("Fetch error:", error);
            });
    }

    function get_financialpaymouts() {
        fetch("sumup/financialpayouts/")  // Replace with the actual URL of your Django view
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then(data => {
                console.log("Data received:", data);

                // Update the HTML on your page with the received data
                const objectCount = Object.keys(data.data.items).length;
                document.getElementById("total_financialpayouts").innerHTML = objectCount;




            })
            .catch(error => {
                console.error("Fetch error:", error);
            });
    }

    get_total_transactions();

    function product_summury() {
        const productSummaries = transactions.map(transaction => transaction.product_summary.toLowerCase());

        const uniqueProductSummaries = [...new Set(productSummaries)];

        console.log(uniqueProductSummaries, 'uniqueProductSummaries')
        // Clear existing options
        productSummarySelect.innerHTML = '';
        productSummarySelectBar.innerHTML = '';

        // Add a default option
        const defaultOption = document.createElement('option');
        defaultOption.text = 'All';
        defaultOption.value = '';
        productSummarySelect.add(defaultOption);

        const defaultOptionBar = document.createElement('option');
        defaultOptionBar.text = 'All';
        defaultOptionBar.value = '';
        productSummarySelectBar.add(defaultOptionBar);

        uniqueProductSummaries.forEach(summary => {
            const option = document.createElement('option');
            option.text = summary;
            option.value = summary;
            productSummarySelect.add(option);
        });

        // Add each unique product summary as an option to the second select
        uniqueProductSummaries.forEach(summary => {
            const option = document.createElement('option');
            option.text = summary;
            option.value = summary;
            productSummarySelectBar.add(option);
        });

    }


    //============================================   chart section ===========================================

    function handleProductSummuryChange() {
        // Get the selected product summary
        const selectedProductSummary = productSummarySelect.value;

        // Filter transactions based on the selected product summary
        const filteredTransactions = transactions.filter(transaction => {
            return selectedProductSummary === '' || transaction.product_summary.toLowerCase() === selectedProductSummary;
        });

        // Call the modified createLineChart function with the filtered transactions
        createLineChart(filteredTransactions);
    }

    function handleProductSummuryBarChange() {
        // Get the selected product summary
        const selectedProductSummary = productSummarySelectBar.value;

        // Filter transactions based on the selected product summary
        const filteredTransactions = transactions.filter(transaction => {
            return selectedProductSummary === '' || transaction.product_summary.toLowerCase() === selectedProductSummary;
        });

        // Call the modified createLineChart function with the filtered transactions
        createBarChart(filteredTransactions);
    }



    let transactionChart;
    function createLineChart(transactions) {
        if (transactionChart) {
            transactionChart.destroy();
        }

        const ctx = document.getElementById('transactionChart').getContext('2d');

        const dateCounts = [];

        transactions.forEach(transaction => {
            const dateKey = new Date(transaction.timestamp).toLocaleDateString();
            const existingDate = dateCounts.find(item => item.date === dateKey);
            if (existingDate) {
                existingDate.count += 1;
            } else {
                dateCounts.push({
                    date: dateKey,
                    count: 1
                });
            }
        });

        // Extract counts to create an array
        const countsArray = dateCounts.map(item => item.count);
        console.log(countsArray, 'countsArray')

        // 99999999999999999999999999
        const timestamps = new Set();
        transactions.forEach(transaction => {
            const timestamp = new Date(transaction.timestamp).toLocaleDateString();
            timestamps.add(timestamp);
        });
        const uniqueTimestampsArray = Array.from(timestamps);

        // const labels = Object.keys(dateCounts);
        const xValues = uniqueTimestampsArray;
        const yValues = countsArray;

        transactionChart = new Chart(ctx, {
            type: "line",
            data: {
                labels: xValues,
                datasets: [{
                    label: 'Number of Transactions',
                    fill: false,
                    lineTension: 0.3,
                    backgroundColor: "rgba(0,0,255,1.0)",
                    borderColor: "rgba(0,0,255,0.1)",
                    data: yValues
                }]
            },
            options: {
                legend: { display: false },
                scales: {
                    yAxes: [{ ticks: { min: 0, max: 16 } }],
                }
            }
        });




    }



    let transactionBarChart;
    function createBarChart(transactions) {
        if (transactionBarChart) {
            transactionBarChart.destroy();
        }

        const ctx = document.getElementById('transactionBarChart').getContext('2d');

        const dateCounts = [];

        transactions.forEach(transaction => {
            const dateKey = new Date(transaction.timestamp).toLocaleDateString();
            const existingDate = dateCounts.find(item => item.date === dateKey);
            if (existingDate) {
                existingDate.count += 1;
            } else {
                dateCounts.push({
                    date: dateKey,
                    count: 1
                });
            }
        });

        // Extract counts to create an array
        const countsArray = dateCounts.map(item => item.count);
        console.log(countsArray, 'countsArray')

        // 99999999999999999999999999
        const timestamps = new Set();
        transactions.forEach(transaction => {
            const timestamp = new Date(transaction.timestamp).toLocaleDateString();
            timestamps.add(timestamp);
        });
        const uniqueTimestampsArray = Array.from(timestamps);

        // const labels = Object.keys(dateCounts);
        const xValues = uniqueTimestampsArray;
        const yValues = countsArray;

        transactionBarChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: xValues,
                datasets: [{
                    label: 'Number of Transactions',
                    fill: false,
                    lineTension: 0.3,
                    backgroundColor: "#e842ff",
                    borderColor: "rgba(0,0,255,0.1)",
                    data: yValues,
                    barThickness: 30
                }]
            },
            options: {
                indexAxis: 'y',
                legend: { display: false },
                scales: {
                    x: {
                        ticks: { min: 0, max: 16 },
                        // grid: { display: false } // Remove x-axis grid lines
                    },
                    y: {
                        ticks: { min: 0, max: 16 },
                        grid: { display: false }

                    }
                }
            }
        });




    }


</script>


<!--  Chart Section  -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>



{% endblock %}